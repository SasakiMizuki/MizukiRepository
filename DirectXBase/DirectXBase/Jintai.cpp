// 階層型人体クラス実装
#define _CRT_SECURE_NO_WARNINGS
#define _CRT_NON_CONFORMING_SWPRINTFS
#include <stdio.h>
#include "GameWnd.h"
#include "Jintai.h"
#include "Input.h"
#include "Fade.h"

const float PLAYER_SPEED(3.0f);
const float ROLLING_SPEED(5.0f);

CMesh*	CJintai::m_pMesh;

enum EModel {
	MODEL_BODY_0 = 0,
	MODEL_BODY_1,
	MODEL_HEAD,
	MODEL_ARM_0,
	MODEL_ARM_1,
	MODEL_ARM_2,
	MODEL_LEG_0,
	MODEL_LEG_1,
	MODEL_LEG_2,
	MODEL_ARM_R_0,
	MODEL_ARM_R_1,
	MODEL_ARM_R_2,
	MODEL_LEG_R_0,
	MODEL_LEG_R_1,
	MODEL_LEG_R_2,
};

LPCTSTR g_pszDir = _T("../data/model/player/");
//LPCTSTR g_pszDir = _T("");
LPCTSTR g_pszFName[] = {
	_T("player_hip.x"),
	_T("player_body.x"),
	_T("player_face.x"),
	_T("player_kata_l.x"),
	_T("player_ude.x"),
	_T("player_hand.x"),
	_T("player_momo.x"),
	_T("player_asi.x"),
	_T("player_asisaki.x"),
	_T("player_kata_r.x"),
	_T("player_ude.x"),
	_T("player_hand.x"),
	_T("player_momo.x"),
	_T("player_asi.x"),
	_T("player_asisaki.x"),
};
struct {
	int			nParent;
	int			nModel;
	D3DVECTOR	vPos;
	D3DVECTOR	vAngle;
} g_parts_init[] = {
	{ -1,               MODEL_BODY_0,{ 0.0f, 80.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_BODY,       MODEL_BODY_1,{ 0.0f, 25.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_BODY1,      MODEL_HEAD,{ 0.0f, 20.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_BODY1,      MODEL_ARM_0,{ 25.0f, 10.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_SHOULDER_L, MODEL_ARM_1,{ 0.2f, -20.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_ARM_L,      MODEL_ARM_2,{ 0.32f, -23.0f, -0.46f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_BODY1,      MODEL_ARM_R_0,{ -25.0f, 10.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_SHOULDER_R, MODEL_ARM_R_1,{ -0.2f, -20.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_ARM_R,      MODEL_ARM_R_2,{ -0.32f, -23.0f, -0.46f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_BODY,       MODEL_LEG_0,{ 12.0f, -15.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_THIGH_L,    MODEL_LEG_1,{ 0.415f, -23.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_LEG_L,      MODEL_LEG_2,{ 1.5f, -26.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_BODY,       MODEL_LEG_R_0,{ -12.0f, -15.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_THIGH_R,    MODEL_LEG_R_1,{ -0.415f, -23.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
	{ PARTS_LEG_R,      MODEL_LEG_R_2,{ -1.5f, -26.0f, 0.0f },{ 0.0f, 0.0f, 0.0f } },
};
typedef struct {
	int	nTime;
	D3DVECTOR	vPos[MAX_PARTS];
	D3DVECTOR	vAngle[MAX_PARTS];
}anum_data; 

anum_data g_anim_stand[] = {

	{ 0,{ { 0.060000f, -2.795601f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -36.000000f, 0.000000f, 0.000000f },{ -26.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -25.000000f, 20.000000f, -20.000000f },{ -40.000000f, 9.000000f, 29.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -14.000000f, 18.000000f, 0.000000f },{ 13.000000f, 0.000000f, 0.000000f },{ 7.000000f, 0.000000f, 0.000000f },{ -16.000000f, 0.000000f, -5.000000f },{ 28.000000f, 0.000000f, 0.000000f },{ -5.000000f, -1.000000f, 1.000000f }, } },
	{ 20,{ { 0.060000f, -0.895195f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -36.000000f, 0.000000f, 0.000000f },{ -26.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -25.000000f, 20.000000f, -20.000000f },{ -40.000000f, 9.000000f, 29.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -7.000000f, 18.000000f, -4.000000f },{ 13.000000f, -13.000000f, 2.000000f },{ 7.000000f, 0.000000f, 0.000000f },{ -12.000000f, 0.000000f, -4.000000f },{ 17.000000f, 0.000000f, 0.000000f },{ 1.000000f, -1.000000f, 1.000000f }, } },
	{ 40,{ { 0.060000f, -2.795601f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -36.000000f, 0.000000f, 0.000000f },{ -26.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -25.000000f, 20.000000f, -20.000000f },{ -40.000000f, 9.000000f, 29.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -14.000000f, 18.000000f, 0.000000f },{ 13.000000f, 0.000000f, 0.000000f },{ 7.000000f, 0.000000f, 0.000000f },{ -16.000000f, 0.000000f, -5.000000f },{ 28.000000f, 0.000000f, 0.000000f },{ -5.000000f, -1.000000f, 1.000000f }, } },

};
anum_data g_anim_work[] = {

	{ 0,{ { 0.060000f, -11.460182f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 18.000000f, 0.000000f, 0.000000f },{ 8.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -39.000000f, 0.000000f, 0.000000f },{ -49.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -24.000000f, -27.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -79.000000f, 0.000000f, 0.000000f },{ 66.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 36.000000f, 0.000000f, 0.000000f },{ 33.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, } },
	{ 15,{ { 0.060000f, -6.860252f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 18.000000f, 0.000000f, 0.000000f },{ 8.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -22.000000f, 22.000000f, 0.000000f },{ -49.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -24.000000f, -27.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -41.000000f, 0.000000f, 0.000000f },{ 69.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -28.000000f, 0.000000f, 0.000000f },{ 48.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, } },
	{ 30,{ { 0.060000f, -11.460182f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 18.000000f, 0.000000f, 0.000000f },{ 8.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -37.000000f, 28.000000f, 0.000000f },{ -49.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -24.000000f, -27.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 34.000000f, 0.000000f, 0.000000f },{ 44.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -75.000000f, 0.000000f, 0.000000f },{ 48.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, } },
	{ 45,{ { 0.060000f, -6.860252f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 18.000000f, 0.000000f, 0.000000f },{ 8.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -22.000000f, 22.000000f, 0.000000f },{ -49.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -24.000000f, -27.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -41.000000f, 0.000000f, 0.000000f },{ 69.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -28.000000f, 0.000000f, 0.000000f },{ 48.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, } },
	{ 60,{ { 0.060000f, -11.460182f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 18.000000f, 0.000000f, 0.000000f },{ 8.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -39.000000f, 0.000000f, 0.000000f },{ -49.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -24.000000f, -27.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -79.000000f, 0.000000f, 0.000000f },{ 66.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 36.000000f, 0.000000f, 0.000000f },{ 33.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, } },

};
anum_data g_anim_attack[] = {


	{ 0,{ { 0.060000f, -2.795601f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -36.000000f, 0.000000f, 0.000000f },{ -26.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -25.000000f, 20.000000f, -20.000000f },{ -40.000000f, 9.000000f, 29.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -14.000000f, 18.000000f, 0.000000f },{ 13.000000f, 0.000000f, 0.000000f },{ 7.000000f, 0.000000f, 0.000000f },{ -16.000000f, 0.000000f, -5.000000f },{ 28.000000f, 0.000000f, 0.000000f },{ -5.000000f, -1.000000f, 1.000000f }, } },
	{ 15,{ { 0.060000f, -10.960190f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -178.000000f, 11.000000f, 16.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 8.000000f, -2.000000f, -9.000000f },{ -70.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -34.000000f, 2.000000f, 13.000000f },{ 57.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -23.000000f, -17.000000f, 0.000000f },{ 38.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, } },
	{ 30,{ { 0.060000f, -10.960190f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 10.000000f, 0.000000f, 0.000000f },{ 15.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -58.000000f, -38.000000f, 16.000000f },{ 2.000000f, 7.000000f, -45.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 8.000000f, -2.000000f, -9.000000f },{ -70.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -56.000000f, 2.000000f, 13.000000f },{ 71.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -49.000000f, -17.000000f, 0.000000f },{ 60.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, } },
	{ 45,{ { 0.060000f, -7.260246f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { -1.000000f, 0.000000f, 0.000000f },{ 5.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -136.000000f, 9.000000f, 12.000000f },{ 1.000000f, 2.000000f, -12.000000f },{ 0.000000f, -36.000000f, 0.000000f },{ 8.000000f, -2.000000f, -9.000000f },{ -70.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -6.000000f, -2.000000f, 8.000000f },{ 17.000000f, 9.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -26.000000f, -17.000000f, 0.000000f },{ 31.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, } },
	{ 60,{ { 0.060000f, -7.260246f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { -1.000000f, 0.000000f, 0.000000f },{ 5.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -16.000000f, 34.000000f, 32.000000f },{ -6.000000f, 2.000000f, -12.000000f },{ 0.000000f, -36.000000f, 0.000000f },{ 8.000000f, -2.000000f, -9.000000f },{ -24.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -6.000000f, -2.000000f, 8.000000f },{ 17.000000f, 9.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -26.000000f, -17.000000f, 0.000000f },{ 31.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, } },
	{ 75,{ { 0.060000f, -7.260246f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { -1.000000f, -23.000000f, 0.000000f },{ 5.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -77.000000f, 56.000000f, -75.000000f },{ -31.000000f, 2.000000f, -12.000000f },{ 0.000000f, -36.000000f, 0.000000f },{ 8.000000f, -2.000000f, -9.000000f },{ -24.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -38.000000f, 8.000000f, 8.000000f },{ 49.000000f, 9.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 26.000000f, -11.000000f, 0.000000f },{ 3.000000f, 0.000000f, 0.000000f },{ -3.000000f, 0.000000f, -9.000000f }, } },
	{ 95,{ { 0.060000f, -7.260246f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 0.000000f, 124.000000f, 0.000000f },{ 5.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -49.000000f, 59.000000f, -30.000000f },{ -20.000000f, -16.000000f, -76.000000f },{ 0.000000f, -36.000000f, 0.000000f },{ 8.000000f, -2.000000f, -9.000000f },{ -24.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -38.000000f, 8.000000f, 8.000000f },{ 49.000000f, 9.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 26.000000f, -11.000000f, 0.000000f },{ 3.000000f, 0.000000f, 0.000000f },{ -3.000000f, 0.000000f, -9.000000f }, } },
	{ 105,{ { 0.060000f, -7.260246f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 0.000000f, -160.000000f, -1.000000f },{ 5.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -49.000000f, 59.000000f, -30.000000f },{ -20.000000f, -16.000000f, -76.000000f },{ 0.000000f, -36.000000f, 0.000000f },{ 8.000000f, -2.000000f, -9.000000f },{ -24.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -38.000000f, 8.000000f, 8.000000f },{ 49.000000f, 9.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -16.000000f, -11.000000f, 0.000000f },{ 26.000000f, 0.000000f, 0.000000f },{ -3.000000f, 0.000000f, -9.000000f }, } },
	{ 115,{ { 0.060000f, -8.260231f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 2.000000f, -98.000000f, -1.000000f },{ 5.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -15.000000f, 39.000000f, 4.000000f },{ -46.000000f, -53.000000f, -8.000000f },{ 0.000000f, -36.000000f, 0.000000f },{ -28.000000f, -26.000000f, 7.000000f },{ 8.000000f, 22.000000f, 7.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -9.000000f, -7.000000f, 5.000000f },{ 10.000000f, 9.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -4.000000f, -23.000000f, 0.000000f },{ 10.000000f, 0.000000f, 0.000000f },{ -3.000000f, 0.000000f, -9.000000f }, } },
	{ 125,{ { 0.060000f, -8.260231f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 1.000000f, -4.000000f, -1.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -15.000000f, 39.000000f, 4.000000f },{ -46.000000f, -53.000000f, -8.000000f },{ 0.000000f, -36.000000f, 0.000000f },{ -28.000000f, -26.000000f, 7.000000f },{ 8.000000f, 22.000000f, 7.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -9.000000f, -7.000000f, 5.000000f },{ 10.000000f, 9.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -4.000000f, -23.000000f, 0.000000f },{ 10.000000f, 0.000000f, 0.000000f },{ -3.000000f, 0.000000f, -9.000000f }, } },
	{ 136,{ { 0.060000f, -2.795601f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -36.000000f, 0.000000f, 0.000000f },{ -26.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -25.000000f, 20.000000f, -20.000000f },{ -40.000000f, 9.000000f, 29.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -14.000000f, 18.000000f, 0.000000f },{ 13.000000f, 0.000000f, 0.000000f },{ 7.000000f, 0.000000f, 0.000000f },{ -16.000000f, 0.000000f, -5.000000f },{ 28.000000f, 0.000000f, 0.000000f },{ -5.000000f, -1.000000f, 1.000000f }, } },

};
anum_data g_anim_rolling[] = {

	{ 0,{ { 0.060000f, -2.795601f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -36.000000f, 0.000000f, 0.000000f },{ -26.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -25.000000f, 20.000000f, -20.000000f },{ -40.000000f, 9.000000f, 29.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -14.000000f, 18.000000f, 0.000000f },{ 13.000000f, 0.000000f, 0.000000f },{ 7.000000f, 0.000000f, 0.000000f },{ -16.000000f, 0.000000f, -5.000000f },{ 28.000000f, 0.000000f, 0.000000f },{ -5.000000f, -1.000000f, 1.000000f }, } },
	{ 10,{ { 0.060000f, -6.905495f, -0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 56.000000f, 0.000000f, 0.000000f },{ 13.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -122.000000f, 0.000000f, 0.000000f },{ 23.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -135.000000f, -20.000000f, 0.000000f },{ 33.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -36.000000f, 0.000000f, 0.000000f },{ 28.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -35.000000f, 0.000000f, 0.000000f },{ 30.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, } },
	{ 25,{ { 0.060000f, -22.305260f, -0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 165.000000f, 0.000000f, 0.000000f },{ 64.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -122.000000f, 0.000000f, 0.000000f },{ 23.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -135.000000f, -20.000000f, 0.000000f },{ 33.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -62.000000f, 0.000000f, 0.000000f },{ 28.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -59.000000f, -9.000000f, 0.000000f },{ 52.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, } },
	{ 40,{ { 0.060000f, -59.204910f, -0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { -79.000000f, 0.000000f, 0.000000f },{ 64.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -36.000000f, 0.000000f, 25.000000f },{ -17.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -65.000000f, -20.000000f, 0.000000f },{ -38.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -18.000000f, 0.000000f, 0.000000f },{ 28.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -46.000000f, -9.000000f, 0.000000f },{ 92.000000f, 0.000000f, 0.000000f },{ 28.000000f, 0.000000f, 0.000000f }, } },
	{ 55,{ { 0.060000f, -2.795601f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f }, },
	{ { 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -36.000000f, 0.000000f, 0.000000f },{ -26.000000f, 0.000000f, 0.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -25.000000f, 20.000000f, -20.000000f },{ -40.000000f, 9.000000f, 29.000000f },{ 0.000000f, 0.000000f, 0.000000f },{ -14.000000f, 18.000000f, 0.000000f },{ 13.000000f, 0.000000f, 0.000000f },{ 7.000000f, 0.000000f, 0.000000f },{ -16.000000f, 0.000000f, -5.000000f },{ 28.000000f, 0.000000f, 0.000000f },{ -5.000000f, -1.000000f, 1.000000f }, } },

};

anum_data * g_anim_data[] = {
	g_anim_stand,
	g_anim_work,
	g_anim_attack,
	g_anim_rolling
};

// 角度を-180°以上180°未満に
void AdjustDegree(float& fAngle)
{
	while (fAngle < -180.0f) {
		fAngle += 360.0f;
	}
	while (fAngle >= 180.0f) {
		fAngle -= 360.0f;
	}
}

// コンストラクタ
CJintai::CJintai(CSceneBase* pScene, D3DXVECTOR3 position, D3DXVECTOR3 rotation) :
	CMeshObj(pScene),
	m_nTimer(0),
	m_nAnim(0),
	m_pAnimData(NULL),
	m_nAnimData()
{
	m_uID = ID_JINTAI;

	m_nParts = PARTS_BODY;
	m_dwBlink = 0;
	m_bEdit = false;
	m_fSpeed = 0.0f;
	m_angle = D3DXVECTOR3(0.0f, 0.0f, 0.0f);
	m_world._41 = position.x;
	m_world._43 = position.z;
	m_pEnemy = NULL;
	m_fHP = 100.0f;
	m_pScene->Add(this);
}

// デストラクタ
CJintai::~CJintai(void)
{
	if (m_pAnimData) {
		delete m_pAnimData;
		m_pAnimData = NULL;
	}
	ReleaseMesh();
}

// 全メッシュ読み込み
bool CJintai::LoadMesh()
{
	if (m_pMesh) {
		ReleaseMesh();
	}
	TCHAR szPath[_MAX_PATH];
	m_pMesh = new CMesh[_countof(g_pszFName)];
	for (int i = 0; i < _countof(g_pszFName); ++i) {
		_tmakepath(szPath, NULL, g_pszDir, g_pszFName[i], NULL);
		if (!m_pMesh[i].Initialize(szPath)) {
			// メッシュ読み込みエラー
			for (int j = 0; j < i; ++j) {
				m_pMesh[j].Finalize();
			}
			delete[] m_pMesh;
			m_pMesh = NULL;
			return false;
		}

	}
	return true;
}

// 全メッシュ破棄
void CJintai::ReleaseMesh()
{
	if (m_pMesh) {
		for (int i = 0; i < _countof(g_pszFName); ++i) {
			m_pMesh[i].Finalize();
		}
		delete[] m_pMesh;
		m_pMesh = NULL;
	}
}

// インスタンス毎の初期化
void CJintai::Init()
{
	CMeshObj::Init();
	for (int i = 0; i < MAX_PARTS; ++i) {
		m_parts[i].m_nParent = g_parts_init[i].nParent;
		m_parts[i].m_nType = g_parts_init[i].nModel;
		m_parts[i].m_vAngle = g_parts_init[i].vAngle;
		m_parts[i].m_vPos = g_parts_init[i].vPos;
		D3DXQuaternionRotationYawPitchRoll(&m_parts[i].m_q,
			D3DXToRadian(m_parts[i].m_vAngle.y),
			D3DXToRadian(m_parts[i].m_vAngle.x),
			D3DXToRadian(m_parts[i].m_vAngle.z));
	}
	m_nAnimData[0] = _countof(g_anim_stand);
	m_nAnimData[1] = _countof(g_anim_work);
	m_nAnimData[2] = _countof(g_anim_attack);
	m_nAnimData[3] = _countof(g_anim_rolling);

	ChangeMotion(0);

	m_pEnemy = (CEnemy*)Find(ID_ENEMY);
	m_pLand = (CLand*)Find(ID_LAND);
}

// 更新(位置編集モード)
void CJintai::UpdateEdit()
{
	
}

// 更新(アニメーション再生)
void CJintai::UpdateAnimation()
{
	if (!m_pAnimData || m_nAnimData <= 0) {
		return;
	}

	// 線形補間による角度の計算(全パーツ分)
	float t0;			// 始点位置での時刻
	float t1;			// 終点位置での時刻
	float t;			// 現在の時刻
	float dt;			// 時間の変化率
	D3DXVECTOR3 p0x;	// 始点位置(角度)
	D3DXVECTOR3 p1x;	// 終点位置(角度)

	t0 = (float)m_pAnimData[m_nAnim].m_nTime;
	t1 = (float)m_pAnimData[m_nAnim + 1].m_nTime;
	t = (float)m_nTimer;
	dt = (t - t0) / (t1 - t0);
	for (int i = 0; i < MAX_PARTS; i++) {
		// 角度は球面線形補間
//		p0x = m_pAnimData[m_nAnim].m_vAngle[i];
//		p1x = m_pAnimData[m_nAnim + 1].m_vAngle[i];
//		m_parts[i].m_vAngle = p0x + (p1x - p0x) * dt;
//		D3DXQuaternionRotationYawPitchRoll(&m_parts[i].m_q,
//			D3DXToRadian(m_parts[i].m_vAngle.y),
//			D3DXToRadian(m_parts[i].m_vAngle.x),
//			D3DXToRadian(m_parts[i].m_vAngle.z));
		D3DXQuaternionSlerp(&m_parts[i].m_q, &m_pAnimData[m_nAnim].m_q[i], &m_pAnimData[m_nAnim + 1].m_q[i], dt);
		// 位置は線形補間
		p0x = m_pAnimData[m_nAnim].m_vPos[i];
		p1x = m_pAnimData[m_nAnim + 1].m_vPos[i];
		m_parts[i].m_vPos = p0x + (p1x - p0x) * dt;
	}
	++m_nTimer;		// フレーム数+1
	if (m_nTimer >= m_pAnimData[m_nAnim + 1].m_nTime) {
		++m_nAnim;	// キーフレーム+1
		if (m_nAnim >= m_nAnimData[m_nMotion] - 1) {	// 最終キーフレームなら終了
			if (m_bLoop) {
				m_nAnim = 0;
				m_nTimer = 0;
			} else {
				ChangeMotion(0);
				m_bAttack = false;
				m_bRolling = false;
				m_fSpeed = 0.0f;
			}
		}
	}
}

// 更新
void CJintai::Update()
{
	C3DObj::Update();

	D3DXMATRIX enemy = m_pEnemy->GetWorld();

	// モード切替
	if (CInput::GetKeyTrigger(DIK_F6)) {
		m_bEdit = !m_bEdit;
		if (!m_bEdit) {
			m_nAnim = 0;
			m_nTimer = 0;
		}
	}


	
	// アニメーション再生モード
	if (CInput::GetKeyTrigger(DIK_9)) {
		m_nParts = (m_nParts + MAX_PARTS - 1) % MAX_PARTS;
	}
	if (CInput::GetKeyTrigger(DIK_0)) {
		m_nParts = (m_nParts + 1) % MAX_PARTS;
	}
	UpdateAnimation();

	// マトリックス更新
	for (int i = 0; i < MAX_PARTS; ++i) {
		TParts& p = m_parts[i];
		// クォータニオンを回転マトリックスへ
		D3DXMatrixRotationQuaternion(&p.m_matrix, &p.m_q);
		// 平行移動成分を設定
		p.m_matrix._41 = p.m_vPos.x;
		p.m_matrix._42 = p.m_vPos.y;
		p.m_matrix._43 = p.m_vPos.z;
		// 親のマトリックスを掛ける
		if (p.m_nParent < 0) {
			p.m_combine = p.m_matrix * m_world;
		} else {
			p.m_combine = p.m_matrix * m_parts[p.m_nParent].m_combine;
		}
	}
	switch(m_nMotion){
	case ANIM_WORK:
		if (m_nMotion != ANIM_WORK)
			ChangeMotion(ANIM_WORK);
	case ANIM_STUND:
		if (CInput::GetKeyRelease(DIK_W) || CInput::GetKeyRelease(DIK_S) || CInput::GetKeyRelease(DIK_A) || CInput::GetKeyRelease(DIK_D)) {
			ChangeMotion(0);
			m_fSpeed = 0.0f;
		}
		//if (CInput::GetKeyTrigger(DIK_UP) || CInput::GetKeyTrigger(DIK_DOWN) || CInput::GetKeyTrigger(DIK_LEFT) || CInput::GetKeyTrigger(DIK_RIGHT)) {
		//	ChangeMotion(1);
		//}
		if (CInput::GetKeyPress(DIK_W) || 
			CInput::GetKeyPress(DIK_S) || 
			CInput::GetKeyPress(DIK_A) || 
			CInput::GetKeyPress(DIK_D)) {
			if(m_nMotion == ANIM_STUND)
				ChangeMotion(1);
		}
		m_angle.y = D3DXToDegree(atan2((enemy._41 - m_world._41), (enemy._43 - m_world._43)));
		if (CInput::GetKeyPress(DIK_A)) {
			m_angle.y += -90.0f;
			m_fSpeed = PLAYER_SPEED;
		}
		if (CInput::GetKeyPress(DIK_D)) {
			m_angle.y += 90.0f;
			m_fSpeed = PLAYER_SPEED;
		}
		if (CInput::GetKeyPress(DIK_W)) {
			m_fSpeed = PLAYER_SPEED;
		}
		if (CInput::GetKeyPress(DIK_S)) {
			m_angle.y += 180.0f;
			m_fSpeed = PLAYER_SPEED;
		}
		if (CInput::GetKeyPress(DIK_L)) {
			m_nMotion = ANIM_ATTACK;
			ChangeMotion(ANIM_ATTACK, false);
			m_bAttack = true;
		}
		if (CInput::GetKeyPress(DIK_K)) {
			m_nMotion = ANIM_ROLLING;
			ChangeMotion(ANIM_ROLLING, false);
			m_bRolling = true;
		}
		if (CInput::GetKeyPress(DIK_I)) {
			CFade::Start(FADEIN);
		}
		if (CInput::GetKeyPress(DIK_O)) {
			CFade::Start(FADEOUT);
		}
		break;
	case ANIM_ATTACK:
		UpdateAttack();
		break;
	case ANIM_ROLLING:
		UpdateRolling();
		break;
	default:
		break;
	}
	D3DXVECTOR3 pos = GetPos();
	D3DXMatrixRotationY(&m_world, D3DXToRadian(m_angle.y));
	D3DXVECTOR3 vZ;
	D3DXVec3TransformNormal(&vZ,
		&D3DXVECTOR3(0.0f, 0.0f, 1.0f), &m_world);
	pos += vZ * m_fSpeed;

	if (pos.x < -2000.0f)
		pos.x = -2000.0f;
	else if (pos.x > 2000.0f)
		pos.x = 2000.0f;
	if (pos.z < -2000.0f)
		pos.z = -2000.0f;
	else if (pos.z > 2000.0f)
		pos.z = 2000.0f;

	SetPos(pos);

	float fAngle = D3DXToDegree(atan2((enemy._41 - m_world._41), (enemy._43 - m_world._43)));
	D3DXMatrixRotationY(&m_PassWorld, D3DXToRadian(fAngle));
	m_PassWorld._41 = pos.x;
	m_PassWorld._42 = pos.y;
	m_PassWorld._43 = pos.z;

	if (m_nMotion != ANIM_ROLLING) {
		
	}
	/*
	D3DXVECTOR3 cross, normal;
	if (m_pLand && m_pLand->Intersect(
		D3DXVECTOR3(pos.x, pos.y + 100.0f, pos.z),
		D3DXVECTOR3(0.0f, -1.0f, -0.0f),
		true, &cross, &normal)) {
		// 進行方向と法線ベクトルからX軸を求める
		D3DXVECTOR3 vX;
		D3DXVec3Cross(&vX, &normal, &vZ);
		D3DXVec3Normalize(&vX, &vX);
		// X軸と法線ベクトルからZ軸を求める
		D3DXVec3Cross(&vZ, &vX, &normal);
		D3DXVec3Normalize(&vZ, &vZ);//多分不要
									// ワールドマトリックスを設定
		SetWorld(D3DXMATRIX(vX.x, vX.y, vX.z, 0.0f,
			normal.x, normal.y, normal.z, 0.0f,
			vZ.x, vZ.y, vZ.z, 0.0f,
			cross.x, cross.y, cross.z, 1.0f));
	} else {
		// 地面の外
		D3DXVECTOR3 vX;
		D3DXVec3Cross(&vX,
			&D3DXVECTOR3(0.0f, 1.0f, 0.0f), &vZ);
		D3DXVec3Normalize(&vX, &vX);
		SetWorld(D3DXMATRIX(vX.x, vX.y, vX.z, 0.0f,
			0.0f, 1.0f, 0.0f, 0.0f,
			vZ.x, vZ.y, vZ.z, 0.0f,
			pos.x, 0.0f, pos.z, 1.0f));
	}
	*/
	
	D3DXVECTOR3 vCross;
	if (m_pLand && m_pLand->Intersect(D3DXVECTOR3(pos.x, pos.y + 5000.0f, pos.z),
		D3DXVECTOR3(0.0f, -1.0f, 0.0f), true, &vCross)) {
		pos.y = vCross.y;
	} else {
		pos.y = 0.0f;
	}
	SetPos(pos);
	
}

// 描画
void CJintai::Draw(CShader* pShader)
{
	for (int i = 0; i < MAX_PARTS; ++i) {
		if (m_bEdit && i == m_nParts && (m_dwBlink & 8) == 0) {
			continue;
		}
		m_pMesh[m_parts[i].m_nType].DrawNoAlpha(m_parts[i].m_combine);
	}
}

// 半透明描画
void CJintai::DrawAlpha()
{

}

// デバッグ用文字列を返す(末尾に追加)
void CJintai::AddDebugStr(LPTSTR pszMsg)
{
	LPCTSTR pszName[] = {
		_T("BODY"),
		_T("BODY1"),
		_T("HEAD"),
		_T("SHOULDER_L"),
		_T("ARM_L"),
		_T("HAND_L"),
		_T("SHOULDER_R"),
		_T("ARM_R"),
		_T("HAND_R"),
		_T("THIGH_L"),
		_T("LEG_L"),
		_T("FOOT_L"),
		_T("THIGH_R"),
		_T("LEG_R"),
		_T("FOOT_R"),
	};
	TCHAR str[MAX_PATH];
	_stprintf(str, _T("Mode[F6] = %s\n"),
		(m_bEdit) ? _T("Edit\n") : _T("Play\n"));
	lstrcat(pszMsg, str);
	_stprintf(str, _T("Save[F7]\n"));
	lstrcat(pszMsg, str);
	_stprintf(str, _T("Key Frame[F5][F8] = %d\n"),
		m_nAnim);
	lstrcat(pszMsg, str);
	_stprintf(str, _T("Parts[9][0] = %s\n"),
		pszName[m_nParts]);
	lstrcat(pszMsg, str);
	_stprintf(str, _T("Pos = {%f, %f, %f}\n"),
		m_parts[m_nParts].m_vPos.x,
		m_parts[m_nParts].m_vPos.y,
		m_parts[m_nParts].m_vPos.z);
	lstrcat(pszMsg, str);
	_stprintf(str, _T("Angle = {%f, %f, %f}\n"),
		m_parts[m_nParts].m_vAngle.x,
		m_parts[m_nParts].m_vAngle.y,
		m_parts[m_nParts].m_vAngle.z);
	lstrcat(pszMsg, str);
	_stprintf(str, _T("Quaternion = {%f, %f, %f, %f}\n"),
		m_parts[m_nParts].m_q.x,
		m_parts[m_nParts].m_q.y,
		m_parts[m_nParts].m_q.z,
		m_parts[m_nParts].m_q.w);
	lstrcat(pszMsg, str);
}

void CJintai::ChangeMotion(int nMotionNumber, bool bLoop) {
	m_nMotion = nMotionNumber;

	m_dwBlink = 0;
	m_nTimer = 0;
	m_nAnim = 0;
	m_bLoop = bLoop;

	if (m_pAnimData) {
		delete m_pAnimData;
		m_pAnimData = NULL;
	}
	m_pAnimData = new TAnimData[m_nAnimData[m_nMotion]];
	D3DXMATRIX m;
	for (int i = 0; i < m_nAnimData[m_nMotion]; ++i) {
		m_pAnimData[i].m_nTime = g_anim_data[m_nMotion][i].nTime;
		for (int j = 0; j < MAX_PARTS; ++j) {
			m_pAnimData[i].m_vAngle[j] = g_anim_data[m_nMotion][i].vAngle[j];
			m_pAnimData[i].m_vAngle[j] += g_parts_init[j].vAngle;
			AdjustDegree(m_pAnimData[i].m_vAngle[j].x);
			AdjustDegree(m_pAnimData[i].m_vAngle[j].y);
			AdjustDegree(m_pAnimData[i].m_vAngle[j].z);
			// 回転マトリックスに対応するクォータニオンを求めておく
			D3DXQuaternionRotationYawPitchRoll(&m_pAnimData[i].m_q[j],
				D3DXToRadian(m_pAnimData[i].m_vAngle[j].y),
				D3DXToRadian(m_pAnimData[i].m_vAngle[j].x),
				D3DXToRadian(m_pAnimData[i].m_vAngle[j].z));
			m_pAnimData[i].m_vPos[j] = g_anim_data[0][i].vPos[j];
			m_pAnimData[i].m_vPos[j] += g_parts_init[j].vPos;
		}
	}
}

// 攻撃中の更新
void CJintai::UpdateAttack() {
	m_fSpeed = 0.0f;
	// 攻撃中に回避は可能
	if (CInput::GetKeyTrigger(DIK_K)) {
		if (CInput::GetKeyPress(DIK_A)) {
			m_angle.y += -90.0f;
		}
		if (CInput::GetKeyPress(DIK_D)) {
			m_angle.y += 90.0f;
		}
		if (CInput::GetKeyPress(DIK_W)) {
			// 現状何もなし
		}
		if (CInput::GetKeyPress(DIK_S)) {
			m_angle.y += 180.0f;
		}
		m_bAttack = false;
		m_nMotion = ANIM_ROLLING;
		ChangeMotion(ANIM_ROLLING, false);
		m_bRolling = true;
	}
}

// 回避中の更新(現状速さのみ)
void CJintai::UpdateRolling() {
	m_fSpeed = ROLLING_SPEED;
}